"use strict";define(["HubLink","RIB","PropertiesPanel","Easy","User"],function(e,t,i,n,o){function s(e,t){return-1!=e.action.indexOf(t)}function r(e,t){return e.action.split(t)[1]}function a(e,t){return Math.floor(Math.random()*(t-e+1)+e).toLocaleString()}function l(e){var t=$(e.currentTarget).attr("data-index");return t.length?Number(t):-1}var c=["Tweet"],u=["SendOK","SendError","NewFollower"],f={};return f.isInputBlock=!0,f.isOutputBlock=!0,f.getTemplateVariables=function(e){var t=[];if(e<this.config.templates.length)for(var i=/_(.*?)_/g,n=this.config.templates[e],o=i.exec(n.text),s="";null!==o;)s=o[1],-1===t.indexOf(s)&&t.push(s),o=i.exec(n.text);return t},f.getActions=function(){var e=c.slice(),t=this;return this.config.templates.forEach(function(i,n){e.push("Preview: "+i.title),e.push("Tweet: "+i.title);f.getTemplateVariables.call(t,n).forEach(function(t){-1===e.indexOf(t)&&e.push("Set: "+t)})}),e},f.getInputs=function(){return u},f.getDefaultAction=function(){return"Tweet"},f.onBeforeSave=function(){return this.config},f.hideDataFeed=function(){return!0},f.hasMissingProperties=function(){return 0===this.config.templates.length},f.onCancelProperties=function(){console.log("Cancelling Properties")},f.onSaveProperties=function(e){this.settings=e},f.onLoad=function(){var e=this;this.config={templates:[],values:{}},this.storedSettings&&this.storedSettings.templates&&(this.config.templates=this.storedSettings.templates||[]),this.loadTemplate("properties.html").then(function(t){return e.propTemplate=t,e.loadTemplate("properties.html","twitter-preview").then(function(t){e.previewBox=t})}),this.loadStyleSheet(this.basePath+"css/twitter-block-style.css").then(function(){console.log("Twitter stylesheet loaded!")}).catch(function(e){console.log("Error loading stylesheet: ",e)}),f.userAuthCheck.call(this)},f.createStreamSubscriptions=function(){var t=this;t.twitterUserInfo||reject("Not authorized");return e.subscribe("service:twitter",{argvs:{type:"followersCountStream"}}).then(function(i){console.log("Event: ",i),t._subsHookId=i,e.on(i,function(e){if(e.follower&&e.followers_count){console.log("Twitter stream event: ",e);var i={newfollower:e.followers_count};t.dispatchDataFeed(i),t.processData(i)}else e.connection_dropped?(console.log("Subscription dropped by the Server!"),f.unsubscribeFromStreams.call(t,f.createStreamSubscriptions.bind(t))):console.log("Invalid event object: ",e)})}).catch(function(e){console.log("Error starting subscription: ",e)})},f.onBeforeDestroy=function(){f.unsubscribeFromStreams.call(this)},f.unsubscribeFromStreams=function(t){if(this._subsHookId){var i=this;return e.unsubscribe(this._subsHookId).then(function(){console.log("Unsubscribed from Twitter Service")}).catch(function(e){console.log("Error unsubscribing from Twitter: ",e),"function"==typeof t&&t(e)}).then(function(){console.log("Removing local subscription listener..."),e.off(i._subsHookId)?console.log("Local subscription removed!"):console.log("Error removing subscription '%s' before Twitter destruction",i._subsHookId),"function"==typeof t&&t()})}},f.userAuthCheck=function(e){var t=this;return t.authorizing=!0,f.renderInterface.call(this),console.log("Checking authorization..."),f.sendRequest.call(this,"isAuthorized").then(function(e){console.log("Authorization results: ",e),t.authorizing=!1,e.success&&e.data.success&&(t.twitterUserInfo=e.data),f.renderInterface.call(t),f.createStreamSubscriptions.call(t)}).catch(function(e){t.authorizing=!1,console.log("Error authorizing user: ",e),f.renderInterface.call(t)})},f.onExecute=function(e){if("Tweet"===e.action)f.tweet.call(this,e.data);else if(s(e,"Set: ")){var t=r(e,"Set: ");this.config.values[t]=e.data,console.log("Values: ",this.config.values)}else if(s(e,"Preview: ")){i=r(e,"Preview: ");void 0!==(n=f.getTemplateIndexByTitle.call(this,i))&&f.showPreview.call(this,n)}else if(s(e,"Tweet: ")){var i=r(e,"Tweet: "),n=f.getTemplateIndexByTitle.call(this,i);void 0!==n&&f.tweetTemplate.call(this,n)}},f.getFollowers=function(){var e=this;return f.sendRequest.call(this,"getFollowersCount").then(function(t){if(console.log("Total Followers ",t),t.success){var i={followerscount:t.data};e.processData(i)}}).catch(function(e){notification.notify("error","Error getting the followers count"),console.log("Error getting followers count: ",e)})},f.getTemplateIndexByTitle=function(e){for(var t=0;t<this.config.templates.length;t++)if(this.config.templates[t].title===e)return t},f.tweetTemplate=function(e){var t=f.parseTemplate.call(this,e);t&&f.tweet.call(this,t)},f.tweet=function(e){var t=this;return f.sendRequest.call(this,"sendTweet",{message:e}).then(function(e){if(console.log("Send Tweet response: ",e),e.success&&e.data.success){notification.notify("success","Tweet sent!");t.processData({sendok:!0})}else notification.notify("error","Error sending tweet: "+e.reason||e.data.reason||"Unknown")}).catch(function(e){console.log("Error sending tweet: ",e);var i="Error sending tweet";e.data&&"string"==typeof e.data&&(i=e.data),notification.notify("error",i);t.processData({senderror:!0})})},f.sendRequest=function(t,i){return new Promise(function(n,o){var s={argvs:{type:t}};i&&Object.assign(s.argvs,i),e.request("service:twitter",s).then(n).catch(o)})},f.onClick=function(){f.renderInterface.call(this)},f.initAuth=function(){var e=this;return f.sendRequest.call(this,"getAuthUrl").then(function(t){if(t.success&&t.data.success){var i=window.open(t.data.url,"Authorize","location=0,status=0,width=800,height=600");if(!i)return notification.notify("warning","You seem to have a popup blocker, please disable it and try again.");setTimeout(function t(){!1!==i.closed?function(t,i,n){f.userAuthCheck.call(e)}.call(this):setTimeout(t.bind(e),200)}.bind(e),200)}else console.log("Invalid response: ",t),notification.notify("error","Error initiating redirection"),f.renderInterface.call(e)}).catch(function(t){console.log("Error getting auth url: ",t),notification.notify("error","Error initiating authorization"),f.renderInterface.call(e)})},f.renderInterface=function(){var e=this;this.propTemplate&&i.isVisible()&&(n.clearAll(),this.myPropertiesWindow=$(this.propTemplate(this)),this.myPropertiesWindow.find("#btAdd").click(f.addNewTemplate.bind(this)),this.myPropertiesWindow.find("#btEdit").click(f.editTemplate.bind(this)),this.myPropertiesWindow.find("#btDelete").click(f.deleteTemplate.bind(this)),this.myPropertiesWindow.find(".tweet-title").focusout(function(t){var i=l(t);f.updateItem.call(e,i)}),this.myPropertiesWindow.find("#btAuthorize").click(function(t){$(this).addClass("disabled loading"),f.initAuth.call(e)}),n.displayCustomSettings(this.myPropertiesWindow,!0,!0))},f.showPreview=function(e){if(this.previewBox){var t=f.parseTemplate.call(this,e);if(t){var i=moment().format("h:mm A - MMM Do YYYY"),n={basePath:this.basePath,twitterUserInfo:this.twitterUserInfo,contentInit:t.substr(0,200),contentLast:t.substr(201),date:i,replies:a(2,200),retweets:a(200,2e3),likes:a(200,3e4)};this.previewWindow=$(this.previewBox(n));var o=this.previewWindow.closest("#msg-tweet-preview"),s=$("#msg-tweet-preview");s.length&&(o.css("left",s.position().left+"px"),o.css("top",s.position().top+"px"),s.remove()),o.find("#tweet-close-btn").click(function(){o.remove()}),o.appendTo("body"),o.draggable({handle:".header"})}}},f.parseTemplate=function(e){if(e<this.config.templates.length){var t=this.config.templates[e].text,i=f.getTemplateVariables.call(this,e),n=this;if(i)return i.forEach(function(e){t=t.replace("_"+e+"_",n.config.values[e]||"")}),t}},f.addNewTemplate=function(){this.templateCounter=this.templateCounter||0,this.templateCounter++;var e={title:"Template"+this.templateCounter,text:"Type your tweet here. You can use _variableName_ to create dynamic content! #kitsunei"};this.config.templates.push(e),f.renderInterface.call(this)},f.toggleItems=function(e,t){var i=this.myPropertiesWindow.find("#btEdit[data-index='"+t+"']");if(i){var n=i.find("i");n.toggleClass("yellow save",e),n.toggleClass("edit",!e)}},f.editTemplate=function(e){var t=l(e);if(-1!=t){var i=this.myPropertiesWindow.find(".tweet-text-container[data-index='"+t+"']");if(i.length){var n=i.is(":visible");f.toggleItems.call(this,!n,t),n?f.updateItem.call(this,t):i.show()}}},f.updateItem=function(e){var t=this.myPropertiesWindow.find(".tweet-item[data-index='"+e+"']");if(t.length){var i=t.find("#txtContent").val(),n=t.find(".tweet-title").val();this.config.templates[e].text=i,this.config.templates[e].title=n,f.renderInterface.call(this)}},f.deleteTemplate=function(e){var t=l(e);-1!=t&&(this.config.templates.splice(t,1),f.renderInterface.call(this))},f.onNewData=function(){},f.onAddedToCanvas=function(){},f});