"use strict";define(["HubLink","RIB","PropertiesPanel","Easy","User"],function(r,t,e,n,i){var o=["Tweet"],s=["SendOK","SendError","NewFollower"],a={};function l(t,e){return-1!=t.action.indexOf(e)}function c(t,e){return t.action.split(e)[1]}function u(t,e){return Math.floor(Math.random()*(e-t+1)+t).toLocaleString()}function f(t){var e=$(t.currentTarget).attr("data-index");return e.length?Number(e):-1}return a.isInputBlock=!0,a.isOutputBlock=!0,a.getTemplateVariables=function(t){var e=[];if(t<this.config.templates.length)for(var i=/_(.*?)_/g,n=this.config.templates[t],o=i.exec(n.text),r="";null!==o;)r=o[1],-1===e.indexOf(r)&&e.push(r),o=i.exec(n.text);return e},a.getActions=function(){var i=o.slice(),n=this;return this.config.templates.forEach(function(t,e){i.push("Preview: "+t.title),i.push("Tweet: "+t.title),a.getTemplateVariables.call(n,e).forEach(function(t){-1===i.indexOf(t)&&i.push("Set: "+t)})}),i},a.getInputs=function(){return s},a.getDefaultAction=function(){return"Tweet"},a.onBeforeSave=function(){return this.config},a.hideDataFeed=function(){return!0},a.hasMissingProperties=function(){return 0===this.config.templates.length},a.onCancelProperties=function(){console.log("Cancelling Properties")},a.onLoad=function(){var e=this,t="1.2.4";this.config={templates:[],values:{}},r.isMinVersion(t,function(){this.storedSettings&&this.storedSettings.templates&&(this.config.templates=this.storedSettings.templates||[]),this.loadTemplate("properties.html").then(function(t){return e.propTemplate=t,e.loadTemplate("properties.html","twitter-preview").then(function(t){e.previewBox=t,a.renderInterface.call(e)})}),this.loadStyleSheet(this.basePath+"css/twitter-block-style.css").then(function(){console.log("Twitter stylesheet loaded!")}).catch(function(t){console.log("Error loading stylesheet: ",t)}),a.userAuthCheck.call(this)},function(){notification.notify("error","This block requires the Hub to be 1.2.4 or greater!"),e.deactivate()},this)},a.createStreamSubscriptions=function(){var i=this;if(!i.twitterUserInfo)return console.log("Aborting stream subscriptions, no yet authorized");return r.subscribe("service:twitter",{argvs:{type:"followersCountStream"}}).then(function(t){console.log("Event: ",t),i._subsHookId=t,r.on(t,function(t){if(t.follower&&t.followers_count){console.log("Twitter stream event: ",t);var e={newfollower:t.followers_count};i.dispatchDataFeed(e),i.processData(e)}else t.connection_dropped?(console.log("Subscription dropped by the Server!"),a.unsubscribeFromStreams.call(i,a.createStreamSubscriptions.bind(i))):console.log("Invalid event object: ",t)})}).catch(function(t){console.log("Error starting subscription: ",t)})},a.onBeforeDestroy=function(){a.unsubscribeFromStreams.call(this)},a.unsubscribeFromStreams=function(e){if(this._subsHookId){var t=this;return r.unsubscribe(this._subsHookId).then(function(){console.log("Unsubscribed from Twitter Service")}).catch(function(t){console.log("Error unsubscribing from Twitter: ",t),"function"==typeof e&&e(t)}).then(function(){console.log("Removing local subscription listener..."),r.off(t._subsHookId)?console.log("Local subscription removed!"):console.log("Error removing subscription '%s' before Twitter destruction",t._subsHookId),"function"==typeof e&&e()})}},a.userAuthCheck=function(t){var e=this;return e.authorizing=!0,a.renderInterface.call(this),console.log("Checking authorization..."),a.sendRequest.call(this,"isAuthorized").then(function(t){console.log("Authorization results: ",t),e.authorizing=!1,t.success&&t.data.success&&(e.twitterUserInfo=t.data),a.renderInterface.call(e),a.createStreamSubscriptions.call(e)}).catch(function(t){e.authorizing=!1,console.log("Error authorizing user: ",t),a.renderInterface.call(e),notification.notify("warning","Error getting the authorization. This block may not work.")})},a.onExecute=function(t){if("Tweet"===t.action)a.tweet.call(this,t.data);else if(l(t,"Set: ")){var e=c(t,"Set: ");this.config.values[e]=t.data,console.log("Values: ",this.config.values)}else if(l(t,"Preview: ")){var i=c(t,"Preview: ");void 0!==(n=a.getTemplateIndexByTitle.call(this,i))&&a.showPreview.call(this,n)}else if(l(t,"Tweet: ")){var n;i=c(t,"Tweet: ");void 0!==(n=a.getTemplateIndexByTitle.call(this,i))&&a.tweetTemplate.call(this,n)}},a.getFollowers=function(){var i=this;return a.sendRequest.call(this,"getFollowersCount").then(function(t){if(console.log("Total Followers ",t),t.success){var e={followerscount:t.data};i.processData(e)}}).catch(function(t){notification.notify("error","Error getting the followers count"),console.log("Error getting followers count: ",t)})},a.getTemplateIndexByTitle=function(t){for(var e=0;e<this.config.templates.length;e++)if(this.config.templates[e].title===t)return e},a.tweetTemplate=function(t){var e=a.parseTemplate.call(this,t);e&&a.tweet.call(this,e)},a.tweet=function(t){var i=this;return a.sendRequest.call(this,"sendTweet",{message:t}).then(function(t){if(console.log("Send Tweet response: ",t),t.success&&t.data.success){notification.notify("success","Tweet sent!");i.processData({sendok:!0})}else notification.notify("error","Error sending tweet: "+t.reason||t.data.reason||"Unknown")}).catch(function(t){console.log("Error sending tweet: ",t);var e="Error sending tweet";t.data&&"string"==typeof t.data&&(e=t.data),notification.notify("error",e);i.processData({senderror:!0})})},a.sendRequest=function(n,o){return new Promise(function(t,e){var i={argvs:{type:n}};o&&Object.assign(i.argvs,o),r.request("service:twitter",i).then(t).catch(e)})},a.onClick=function(){a.renderInterface.call(this)},a.initAuth=function(){var n=this;return a.sendRequest.call(this,"getAuthUrl").then(function(t){if(t.success&&t.data.success){var e=window.open(t.data.url,"Authorize","location=0,status=0,width=800,height=600");if(!e)return notification.notify("warning","You seem to have a popup blocker, please disable it and try again.");setTimeout(function t(){!1!==e.closed?function(t,e,i){a.userAuthCheck.call(n)}.call(this):setTimeout(t.bind(n),200)}.bind(n),200)}else console.log("Invalid response: ",t),notification.notify("error","Error initiating redirection"),a.renderInterface.call(n)}).catch(function(t){console.log("Error getting auth url: ",t),notification.notify("error","Error initiating authorization"),a.renderInterface.call(n)})},a.renderInterface=function(){var i=this;this.propTemplate&&e.isVisible()&&(n.clearAll(),this.myPropertiesWindow=$(this.propTemplate(this)),this.myPropertiesWindow.find("#btAdd").click(a.addNewTemplate.bind(this)),this.myPropertiesWindow.find("#btEdit").click(a.editTemplate.bind(this)),this.myPropertiesWindow.find("#btDelete").click(a.deleteTemplate.bind(this)),this.myPropertiesWindow.find(".tweet-title").focusout(function(t){var e=f(t);a.updateItem.call(i,e)}),this.myPropertiesWindow.find("#btAuthorize").click(function(t){$(this).addClass("disabled loading"),a.initAuth.call(i)}),n.displayCustomSettings(this.myPropertiesWindow,!0,!0))},a.showPreview=function(t){if(this.previewBox){var e=a.parseTemplate.call(this,t);if(e){var i=moment().format("h:mm A - MMM Do YYYY"),n={basePath:this.basePath,twitterUserInfo:this.twitterUserInfo,contentInit:e.substr(0,200),contentLast:e.substr(201),date:i,replies:u(2,200),retweets:u(200,2e3),likes:u(200,3e4)};this.previewWindow=$(this.previewBox(n));var o=this.previewWindow.closest("#msg-tweet-preview"),r=$("#msg-tweet-preview");r.length&&(o.css("left",r.position().left+"px"),o.css("top",r.position().top+"px"),r.remove()),o.find("#tweet-close-btn").click(function(){o.remove()}),o.appendTo("body"),o.draggable({handle:".header"})}}},a.parseTemplate=function(t){if(t<this.config.templates.length){var e=this.config.templates[t].text,i=a.getTemplateVariables.call(this,t),n=this;if(i)return i.forEach(function(t){e=e.replace("_"+t+"_",n.config.values[t]||"")}),e}},a.addNewTemplate=function(){this.templateCounter=this.templateCounter||0,this.templateCounter++;var t={title:"Template"+this.templateCounter,text:"Type your tweet here. You can use _variableName_ to create dynamic content! #kitsunei"};this.config.templates.push(t),a.renderInterface.call(this)},a.toggleItems=function(t,e){var i=this.myPropertiesWindow.find("#btEdit[data-index='"+e+"']");if(i){var n=i.find("i");n.toggleClass("yellow save",t),n.toggleClass("edit",!t)}},a.editTemplate=function(t){var e=f(t);if(-1!=e){var i=this.myPropertiesWindow.find(".tweet-text-container[data-index='"+e+"']");if(i.length){var n=i.is(":visible");a.toggleItems.call(this,!n,e),n?a.updateItem.call(this,e):i.show()}}},a.updateItem=function(t){var e=this.myPropertiesWindow.find(".tweet-item[data-index='"+t+"']");if(e.length){var i=e.find("#txtContent").val(),n=e.find(".tweet-title").val();this.config.templates[t].text=i,this.config.templates[t].title=n,a.renderInterface.call(this)}},a.deleteTemplate=function(t){var e=f(t);-1!=e&&(this.config.templates.splice(e,1),a.renderInterface.call(this))},a.onNewData=function(t,e){console.log("Parent block is sending: ",t,e)},a});